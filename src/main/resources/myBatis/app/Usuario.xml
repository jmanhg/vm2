<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="mx.com.oposicion.persistence.UsuarioMapper">


	<sql id="camposUsuario">
			u.id,               
			u.usuario,                
			u.clave,                   
			u.correo,                    
			u.nombre,                    
			u.apaterno,                    
			u.amaterno,                    
			u.fecha_creacion,         
			u.cuenta_no_expirada,
			u.cuenta_no_bloqueada,
			u.credencial_no_expirada,
			u.habilitado,
			u.contador_intentos_fallidos,
			u.instante_de_bloqueo,
			u.pregunta_secreta,
			u.respuesta_secreta,
			u.id_de_seguridad,
			u.ventana_para_id_seguridad,
                        u.activo
	</sql>
	
	<sql id="camposUsuario2">
			<include refid="camposUsuario"/>,
			p.codigo_perfil
	</sql>


    <resultMap id="usuarioMap" type="UsuarioType" >
        <result property="idUsuario" column="id"/>
        <result property="usuario" column="usuario"/>
        <result property="clave" column="clave"/>
        <result property="fechaCreacion" column="fecha_creacion"/>
        <result property="correo" column="correo"/>
        <result property="nombre" column="nombre"/>
        <result property="apaterno" column="apaterno"/>
        <result property="amaterno" column="amaterno"/>
        <result property="cuentaNoExpirada" column="cuenta_no_expirada"/>
        <result property="cuentaNoBloqueada" column="cuenta_no_bloqueada"/>
        <result property="credencialNoExpirada" column="credencial_no_expirada"/>
        <result property="habilitado" column="habilitado"/>
        <result property="contadorIntentosFallidos" column="contador_intentos_fallidos"/>
        <result property="instanteDeBloqueo" column="instante_de_bloqueo"/>
        <result property="preguntaSecreta" column="pregunta_secreta"/>
        <result property="respuestaSecreta" column="respuesta_secreta"/>
        <result property="idSeguridad" column="id_de_seguridad"/>
        <result property="ventanaParaIdSeguridad" column="ventana_para_id_seguridad"/>
        <result property="activo" column="activo"/>
        <collection property="perfiles" column="usuario" ofType="PerfilType" javaType="ArrayList" select="getPerfiles"/>
     </resultMap>
     
     <resultMap id="PerfilMap" type="PerfilType">
        <result property="authority" column="codigo_perfil" />
     </resultMap>
     
     <select id="getPerfiles" resultMap="PerfilMap" parameterType="java.lang.String">
     	SELECT
     		codigo_perfil
     	FROM
     		perfiles_por_usuario
     	WHERE
     		usuario=#{usuario}
     </select>
     


    <select id="getUsuarioByName" resultMap="usuarioMap" parameterType="java.lang.String">
		SELECT 
			<include refid="camposUsuario"/>
		FROM 
			usuario u
		WHERE 
			u.usuario=#{usuario}
    </select>
     


    <select id="findById" resultMap="usuarioMap" parameterType="java.lang.Integer">
		SELECT 
			<include refid="camposUsuario"/>
		FROM 
			usuario u
		WHERE 
			u.id=#{idUsuario}
    </select>

    <select id="findByIdClave" resultMap="usuarioMap" parameterType="UsuarioType">
		SELECT 
			<include refid="camposUsuario"/>
		FROM 
			usuario u
		WHERE 
			u.id=#{idUsuario}  and u.clave=#{clave}
    </select>


    <select id="getAll" resultMap="usuarioMap">
		SELECT 
			<include refid="camposUsuario"/>
		FROM 
			usuario u
		WHERE 
			u.activo=1
    </select>


	<insert id="insert" parameterType="UsuarioType">
		INSERT INTO usuario( <include refid="camposUsuario"/> )
 		VALUES(
 			null,              
			#{usuario},                
			#{clave},                   
			#{correo},                    
			#{nombre},                    
			#{apaterno},                    
			#{amaterno},                    
			#{fechaCreacion},         
			#{cuentaNoExpirada},
			#{cuentaNoBloqueada},
			#{credencialNoExpirada},
			#{habilitado},
			#{contadorIntentosFallidos},
			#{instanteDeBloqueo},
			#{preguntaSecreta},
			#{respuestaSecreta},
			#{idSeguridad},
			#{ventanaParaIdSeguridad},
                        #{activo}
		)
		<selectKey keyProperty="id" resultType="int">
			SELECT last_insert_id() AS id
		</selectKey>
    </insert>


	<update id="update" parameterType="UsuarioType">
			UPDATE usuario u SET              
					u.usuario = #{usuario},                
					u.clave = #{clave},                   
					u.correo = #{correo},                    
					u.nombre = #{nombre},                    
					u.apaterno = #{apaterno},                    
					u.amaterno = #{amaterno},                    
					u.fecha_creacion = #{fechaCreacion},         
					u.cuenta_no_expirada = #{cuentaNoExpirada},
					u.cuenta_no_bloqueada = #{cuentaNoBloqueada},
					u.credencial_no_expirada = #{credencialNoExpirada},
					u.habilitado = #{habilitado},
					u.contador_intentos_fallidos = #{contadorIntentosFallidos},
					u.instante_de_bloqueo = #{instanteDeBloqueo},
					u.pregunta_secreta = #{preguntaSecreta},
					u.respuesta_secreta = #{respuestaSecreta},
					u.id_de_seguridad = #{idSeguridad},
					u.ventana_para_id_seguridad = #{ventanaParaIdSeguridad},
                                        u.activo = #{activo}
			WHERE
              	u.id = #{idUsuario}
    </update>
    
    <update id="updateIntentosFallidos" parameterType="UsuarioType">
			UPDATE usuario SET              
					contador_intentos_fallidos = #{contadorIntentosFallidos}
			WHERE
              	id = #{idUsuario}
    </update>
    
    <update id="bloquearUsuario" parameterType="UsuarioType">
			UPDATE usuario SET              
					instante_de_bloqueo = #{instanteDeBloqueo},
					cuenta_no_bloqueada = false
			WHERE
              	id = #{idUsuario}
    </update>
    
    <update id="desBloquearUsuario" parameterType="UsuarioType">
			UPDATE usuario SET              
					instante_de_bloqueo = null,
					contador_intentos_fallidos = 0,
					cuenta_no_bloqueada = true
			WHERE
              	id = #{idUsuario}
    </update>


	<update id="delete" parameterType="UsuarioType">
			UPDATE usuario SET
				activo = 0
			WHERE
              	id = #{idUsuario}
    </update>
</mapper>
